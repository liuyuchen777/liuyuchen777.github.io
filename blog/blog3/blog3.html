<!--
 * @Author: Liu Yuchen
 * @Date: 2021-04-28 21:28:26
 * @LastEditors: Liu Yuchen
 * @LastEditTime: 2021-05-06 03:33:39
 * @Description: 
 * @FilePath: /liuyuchen777.github.io/blog/blog3/blog3.html
 * @GitHub: https://github.com/liuyuchen777
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Meta Tag -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- SEO -->
    <meta name="description" content="150 words">
    <meta name="author" content="Liu Yuchen">
    <meta name="robots" content="index,follow">
    
    
    <title>Pytorch Note</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="../../images/favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="144x144" type="image/x-icon" href="../../images/favicon/apple-touch-icon.png">
    
    <!-- All CSS Plugins -->
    <link rel="stylesheet" type="text/css" href="../../css/plugin.css">
    
    <!-- Main CSS Stylesheet -->
    <link rel="stylesheet" type="text/css" href="../../css/style.css">
    
    <!-- Google Web Fonts  -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:400,300,500,600,700">
    
    <!-- Syntax Highlighter  -->
    <link rel="stylesheet" type="text/css" href="../../css/syntax/shCore.css">
    <link rel="stylesheet" type="text/css" href="../../css/syntax/shThemeDefault.css">
</head>

<body>
    <!-- Preloader Start -->
    <div class="preloader">
    <div class="rounder"></div>
    </div>
    <!-- Preloader End -->

    <div id="main">
        <div class="container">
            <div class="row">
              <!-- About Me (Left Sidebar) Start -->
              <div class="col-md-3">
                <div class="about-fixed">
                
                  <div class="my-pic">
                    <img src="../../images/pic/my-pic.jpg" alt="">
                    <a href="javascript:void(0)" class="collapsed" data-target="#menu" data-toggle="collapse"><i class="icon-menu menu"></i></a>
                      <div id="menu" class="collapse">
                        <ul class="menu-link">
                          <li><a href="../../index.html">Home</a></li>
                          <li><a href="../../about.html">About</a></li>
                          <li><a href="../../contact.html">Contact</a></li>
                          <li><a href="../../pdf/resume.pdf">CV</a></li>
                        </ul>
                      </div>
                    </div>

                  <div class="my-detail">
                  
                    <div class="white-spacing">
                        <h1>Liu Yuchen</h1>
                        <span>Master Student at Tokyo Tech</span>
                    </div> 
                    
                    <ul class="social-icon">
                      <li><a href="https://www.facebook.com/yuchen.liu.1848816/" target="_blank" class="facebook"><i class="fa fa-facebook"></i></a></li>
                      <li><a href="https://twitter.com/qiusenwan" target="_blank" class="twitter"><i class="fa fa-twitter"></i></a></li>
                      <li><a href="https://www.linkedin.com/in/liu-yuchen-252a1b194/" target="_blank" class="linkedin"><i class="fa fa-linkedin"></i></a></li>
                      <li><a href="https://github.com/liuyuchen777" target="_blank" class="github"><i class="fa fa-github"></i></a></li>
                    </ul>

                </div>
              </div>
              </div>
              <!-- About Me (Left Sidebar) End -->

              <!-- Blog Post (Right Sidebar) Start -->
              <div class="col-md-9">
                <div class="col-md-12 page-body">
                  <div class="row">
                    <div class="sub-title">
                      <a href="../../index.html" title="Go to Home Page"><h2>Back Home</h2></a>
                    </div>
                    
                    <div class="col-md-12 content-page">
                      <div class="col-md-12 blog-post">
                        <!-- Post Headline Start -->
                        <div class="post-title">
                            <h1>Pytorch Study Note</h1> 
                        </div>
                        <!-- Post Headline End -->

                        <!-- Post Detail Start -->
                        <div class="post-info">
                          <span>April 28, 2021 / by <a href="#" target="_blank">Liu Yuchen</a></span>
                        </div>
                        <!-- Post Detail End -->
                        
<!--Main Content Start-->

<!-- Post Video Tutorial Start -->
<div class="video-box margin-top-40 margin-bottom-40">
  <div class="video-tutorial">
    <a class="video-popup" href="https://www.youtube.com/watch?v=c36lUUr864M&t=14069s" title="pytorch crush course">
    <img src="../../images/other/pytorch.png" alt="">
    </a>                           
  </div>
  <p>A very detail tutorial course for Pytorch beginners</p>
</div>
<!-- Post Video Tutorial End -->

<h1 id='1-tensor-of-pytorch'>1. tensor of pytorch</h1>
<h2 id='11-create-tensor-in-pytorch'>1.1 create tensor in pytorch</h2>
<p>create tensor in pytorch just like create ndarray in numpy</p>
<pre class="brush: python">
# tensor dim is 3 * 2
a = torch.zeros(3, 2)
# tensor dim is 3 * 3 * 3
b = torch.zeros(3, 3, 3)
# check size of tensor
print(b.size())
# result: torch.Size([3, 3, 2])
# create one val tensor
c = torch.ones(3, 3)
# create random val tensor (val from 0 - 1)
d = torch.rand(3, 3)
</pre>
<h2 id='12-operation-of-tensor'>1.2 operation of tensor</h2>
<p>add, sub, mul, div</p>
<pre class="brush: python"> a = torch.rand(3, 3)
b = torch.rand(3, 3)
# add, three ways
c = a + b
c = torch.add(a, b)
b.add_(a) 
# all function in pytorch with _, will replace value of the obj, 
# adove add_ wil modify value of b
# sub, three ways
c = a - b
c = torch.sub(a, b)
a.sub_(b)
# multiply, three ways
c = a * b
c = torch.mul(a, b)
a.mul_(b)
# divide, three ways
c = a / b
c = torch.div(a, b)
a.div_(b)
</code></pre>
<h2 id='13-slice-of-tensor'>1.3 slice of tensor</h2>
<p>just like slice in numpy</p>
<pre class="brush: python"> x = torch.rand(5, 3)
print(x)
print(x[1, :]) # print second row of all columns

</code></pre>
<h2 id='14-reshape-tensor'>1.4 reshape tensor</h2>
<p>view method</p>
<pre class="brush: python"> x = torch.rand(4, 4)
y = x.view(16) # become 1 * 16
# or you want to automatically compute
y = x.view(-1, 8) # become 2 * 8
</code></pre>
<h2 id='15-ndarray-and-tensor-conversion'>1.5 ndarray and tensor conversion</h2>
<pre class="brush: python"> # tensor to ndarray
a = torch.ones(5)
b = a.numpy()
print(type(b)) # b is ndarray
</code></pre>
<p>It&#39;s worth to note that if tensor is in cpu rather than cpu, ndarray convert from tensor will use the same memory, which means you change one will affect another one</p>
<pre class="brush: python"> # ndarray to tensor
a = np.ones(5)
b = torch.from_numpy(a)
# or
b = torch,tensor(a)
print(type(b))
</code></pre>
<p>see gpu tensor cases</p>
<pre class="brush: python"> # gpu cases
if torch.cuda.is_available():
	device = torch.device(&quot;cuda&quot;)
	x = torch.ones(5, device=device)
	y = torch.ones(5)
	y = y.to(device)
	z = x + y # perform on gpu and may be faster
	# w = z.numpy() # error, numpy can only handle cpu tensor
	z = z.to(&quot;cpu&quot;) # z will be on cpu again
	w = z.numpy() # ok now
</code></pre>
<h2 id='16-grad'>1.6 grad</h2>
<p>autograd attribute</p>
<pre class="brush: python"> # gradient on tensor
x = torch.ones(5, requires_grad=True)
print(x)
</code></pre>
<h1 id='2-autograd-package-in-numpy'>2. autograd package in numpy</h1>
<p>If you open requires_grad=True for a tensor, any operation on this tensor will be recorded, which is called computation graph in pytorch.</p>
<pre class="brush: python"> # set requires_grad to True
x = torch.randn(3, requires_grad=True)
print(x)
y = x + 2
print(y) # tensor([2.0274, 1.6265, 0.9969], grad_fn=&lt;AddBackward0&gt;)
z = y * y * 2
print(z) # tensor([8.2209, 5.2909, 1.9876], grad_fn=&lt;MulBackward0&gt;)
w = z.mean()
print(w) # tensor(5.1665, grad_fn=&lt;MeanBackward0&gt;)

w.backward() # dz/dx
print(x.grad)
# or
v = torch.tensor([1, 0.1, 0.01], dtype=torch.float64)
w.backward(v)
print(x.grad)
</pre>

<p>some additional function in autograd</p>
<pre class="brush: python"> # cancel gradient
x.requires_grad_(False) # set reuqires_gradient -&gt; false
y = x.detach() # detach gradient
with torch.no_grad():
	# some operation
	y = x + 2
	print(y) # no gradient attribute

# clear gradient now, prevant accumulate of gradient
weights.grad.zero_()

# work with optimizer
optimizer = torch.optim.SGD(weights, lr=0.01)
optimizer.step()
optimizer.zero_grad()
</code></pre>
<h1 id='3-backpropagation'>3. backpropagation</h1>
<!-- Post Image Start -->
<div class="post-image margin-top-40 margin-bottom-40">
  <img src="../../images/blog/blog3/1.png" alt="">                                    
</div>
<!-- Post Image End -->
<pre class="brush: python"> import torch

x = torch.tensor(1.0)
y = torch.tensor(2.0)

w = torch.tensor(1.0, requires_grad=True)

# forward pass and compute the loss
y_hat = w * x
loss = (y_hat - y)**2

print(loss)

# backward pass
loss.backward()
print(w.grad)

# use gradient to update val of w
...
</code></pre>
<h1 id='4-gradient-descent'>4. gradient descent</h1>
<h2 id='41-numpy-version'>4.1 numpy version</h2>
<pre class="brush: python"> import numpy as np

# f = w * x

# f = 2 * x
X = np.array([1, 2, 3, 4], dtype=np.float32)
Y = np.array([2, 4, 6, 8], dtype=np.float32)

W = 0.0

# model prediction
def forward(x):
    return W * x

# loss = MSE
def loss(y, y_pred):
    return ((y_pred - y) ** 2).mean()

# gradient
# MSE = 1/N * (w * x - y)**2
# dj/dw = 1/N * 2x * (w * x - y)
def gradient(x, y, y_pred):
    return np.dot(2 * x, y_pred - y).mean()

if __name__ == &quot;__main__&quot;:
    print(f&#39;Prediction before training: f(5) = {forward(5):.3f}&#39;)

    # training
    learning_rate = 0.01
    n_iter = 100

    for epoch in range(n_iter):
        # predication = forward pass
        y_predict = forward(X)

        # loss
        l = loss(Y, y_predict)

        # gradient
        dw = gradient(X, Y, y_predict)

        # update weight
        W -= dw * learning_rate

        # print training process
        if epoch % 10 == 0:
            print(f&#39;epoch {epoch+1}: w = {W:.3f}, loss = {l:.3f}&#39;)

    print(f&#39;Prediction before training: f(5) = {forward(5):.3f}&#39;)
</code></pre>
<h2 id='42-torch-version'>4.2 torch version</h2>
<pre class="brush: python"> import torch

# f = w * x

# f = 2 * x
X = torch.tensor([1, 2, 3, 4], dtype=torch.float32)
Y = torch.tensor([2, 4, 6, 8], dtype=torch.float32)

W = torch.tensor(0.0, dtype=torch.float32, requires_grad=True)

# model prediction
def forward(x):
    return W * x

# loss = MSE
def loss(y, y_pred):
    return ((y_pred - y) ** 2).mean()

&quot;&quot;&quot;
# gradient
# MSE = 1/N * (w * x - y)**2
# dj/dw = 1/N * 2x * (w * x - y)
def gradient(x, y, y_pred):
    return np.dot(2 * x, y_pred - y).mean()
&quot;&quot;&quot;

if __name__ == &quot;__main__&quot;:
    print(f&#39;Prediction before training: f(5) = {forward(5):.3f}&#39;)

    # training
    learning_rate = 0.01
    n_iter = 20

    for epoch in range(n_iter):
        # predication = forward pass
        y_predict = forward(X)

        # loss
        l = loss(Y, y_predict)

        # gradient = backward pass
        l.backward()

        # update weight
        with torch.no_grad():
            W -= W.grad * learning_rate

        # zero grad
        W.grad.zero_()

        # print training process
        if epoch % 2 == 0:
            print(f&#39;epoch {epoch + 1}: w = {W:.3f}, loss = {l:.3f}&#39;)

    print(f&#39;Prediction before training: f(5) = {forward(5):.3f}&#39;)
</code></pre>
<h1 id='5-training-pipeline'>5. training pipeline</h1>
<p>Training pipeline for NN:</p>
<ol start='' >
<li><p>design model (input, output size, forward pass)</p>
</li>
<li><p>construct loss and optimizer</p>
</li>
<li><p>training loop</p>
<ul>
<li>forward pass: compute prediction</li>
<li>backward pass: gradients</li>
<li>update weights</li>

</ul>
</li>

</ol>
<p>an example with torch.nn</p>
<pre class="brush: python"> import torch
import torch.nn as nn

# f = w * x

# f = 2 * x
X = torch.tensor([[1], [2], [3], [4]], dtype=torch.float32)
Y = torch.tensor([[2], [4], [6], [8]], dtype=torch.float32)

X_test = torch.tensor([[5]], dtype=torch.float32)

n_samples, n_features = X.shape
print(n_samples, n_features)

input_size = n_features
output_size = n_features

# model = nn.Linear(input_size, output_size)

class LinearRegression(nn.Module):
    def __init__(self, input_dim, output_dim):
        super(LinearRegression, self).__init__()
        self.lin = nn.Linear(input_dim, output_dim)

    def forward(self, x):
        return self.lin(x)

model = LinearRegression(input_size, output_size)

if __name__ == &quot;__main__&quot;:
    print(f&#39;Prediction before training: f(5) = {model(X_test).item():.3f}&#39;)

    # training
    learning_rate = 0.01
    show = 10
    n_iter = 10 * show
    loss = nn.MSELoss()
    optimizer = torch.optim.SGD(model.parameters(), lr=learning_rate)

    for epoch in range(n_iter):
        # predication = forward pass
        y_predict = model(X)

        # loss
        l = loss(Y, y_predict)

        # gradient = backward pass
        l.backward()

        # update weight
        optimizer.step()

        # zero grad
        optimizer.zero_grad()

        # print training process
        if epoch % show == 0:
            [w, b] = model.parameters()
            print(f&#39;epoch {epoch + 1}: w = {w[0][0].item():.3f}, loss = {l:.3f}&#39;)

    print(f&#39;Prediction After training: f(5) = {model(X_test).item():.3f}&#39;)
</code></pre>
<h1 id='6-data-loader'>6. data loader</h1>
<p>write you own dataset class</p>
<pre class="brush: python"> from torch.utils.data import Dataset, DataLoader

class WineDataset(Dataset):
    def __init__(self):
        # data loading
        xy = np.loadtxt(&#39;./wine.csv&#39;, delimiter=&quot;,&quot;, dtype=np.float32, skiprows=1)
        self.x = torch.from_numpy(xy[:, 1:])
        self.y = torch.from_numpy(xy[:, [0]])     # n_samples, 1
        self.n_samples = xy.shape[0]

    def __getitem__(self, index):
        # dataset[0]
        return self.x[index], self.y[index]

    def __len__(self):
        # len(dataset)
        return self.n_samples
</code></pre>
<p>epoch</p>
<p>batch</p>
<p>iter</p>
<h1 id='7-softmax-and-cross-entropy'>7. softmax and cross entropy</h1>
<h2 id='71-softmax'>7.1 softmax</h2>
<!-- Post Image Start -->
<div class="post-image margin-top-40 margin-bottom-40">
  <img src="../../images/blog/blog3/2.png" alt="">                                    
</div>
<!-- Post Image End -->
<p>softmax layer</p>
<p>the sum of output of softmax is 1 and each value is between 0 and 1</p>
<!-- Post Image Start -->
<!-- Post Image End -->
<p>softmax in pytorch</p>
<pre class="brush: python"> import torch
import torch.nn as nn
import numpy as np

def softmax(x):
    return np.exp(x) / np.sum(np.exp(x), axis=0)

x = np.array([2.0, 1.0, 0.1])
outputs = softmax(x)
print(&quot;softmax numpy: &quot;, outputs)
x = torch.tensor([2.0, 1.0, 0.1])
outputs = torch.softmax(x, dim=0)
print(&quot;softmax torch: &quot;, outputs)
</code></pre>
<h2 id='72-cross-entropy'>7.2 cross entropy</h2>
<p>two examples with a godd and a bad predictio</p>

<!-- Post Image Start -->
<div class="post-image margin-top-40 margin-bottom-40">
  <img src="../../images/blog/blog3/3.png" alt="">                                    
</div>
<!-- Post Image End -->

<p>nn.CrossEntropyLoss applies nn.LogSoftmax + nn.NLLLoss (negative log likelihood)</p>
<h1 id='8-save-and-load-model'>8. save and load model</h1>
<p>there are two different ways in pytorch to save model</p>
<ol start='' >
<li>save the whole model</li>

</ol>
<pre class="brush: python"> # save entire model
FILE = &quot;model.pth&quot;
torch.save(model, FILE)

# load
loaded_model = torch.load(FILE)
loaded_model.eval()

for param in loaded_model.parameters():
    print(param)
</code></pre>
<ol start='2' >
<li>recommended way: say only teh state dict</li>

</ol>
<pre class="brush: python"> # save
FILE = &quot;model.pth&quot;
torch.save(model.state_dict(), FILE)

# load
print(model.state_dict())
loaded_model = Model(n_input_features=6)
loaded_model.load_state_dict(torch.load(FILE)) # it takes the loaded dictionary, not the path file itself
loaded_model.eval()

print(loaded_model.state_dict())
</code></pre>

<!--Main Content End-->

                    <!-- Post Author Bio Box End -->
                    <div class="about-author margin-top-70 margin-bottom-50">
                    
                      <div class="picture">
                        <img src="../../images/pic/my-pic.jpg" class="img-responsive" alt="">
                      </div>
                    
                      <div class="c-padding">
                        <h3>Article By <a href="https://liuyuchen777.github.io">Liu Yuchen</a></h3>
                        <p>Master student at Tokyo Tech.</p>
                      </div>
                    </div>
                    <!-- Post Author Bio Box End -->

                    <!-- You May Also Like Start -->
                    <div class="you-may-also-like margin-top-50 margin-bottom-50">
                      <h3>You may also like</h3>
                      <div class="row">
                    
                      <div class="col-md-4 col-sm-6 col-xs-12">
                        <a href="https://www.notion.so/2021-3bae50f975aa497da7b8cc9428d31f4f"><p>Trip to Hokkaido 2021 Winter</p></a>
                      </div>
      
                      <div class="col-md-4 col-sm-6 col-xs-12">
                        <a href="https://www.notion.so/Docker-2d5478a51bb14af8a15b7bda4c76f54f"><p>[Beginner] Docker Study Note</p></a>
                      </div>
      
                      <div class="col-md-4 col-sm-6 col-xs-12">
                        <a href="../../index.html"><p>Space Chat Program --- BinauralMeet</p></a>
                      </div>
                      
                      </div>
                    </div>
                    <!-- You May Also Like End -->

                    <!-- comment start -->
                    <div id="gitalk-container"></div> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
                    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script> 
                    <script>
                        var gitalk  = new Gitalk ({
                            id: window.location.pathname,   // Ensure uniqueness and length less than 50
                            clientID: '8e1d9ed9c65d6df32019',
                            clientSecret: '4f446e929381fcfe6e983af0485224ea2edd2553',
                            repo: 'liuyuchen777.github.io',
                            owner: 'liuyuchen777',
                            admin: ['liuyuchen777'],
                            distractionFreeMode: false  // Facebook-like distraction free mode
                        })
                        gitalk.render('gitalk-container')
                    </script> 
                    </div>
                    <!-- comment end -->
                  </div>    
                </div>
              </div>
            </div>

  <!-- Footer Start -->
  <div class="col-md-12 page-body margin-top-50 footer">
    <footer>
    <p>Everyday is a new day. Everytime the me you meet is new me.</p>
    <!-- count click start -->
    <a href="https://github.com/vinci7/pv-badge">
      <img alt="pv-badge" src="https://pv-badge.herokuapp.com/total.svg/liuyuchen777.github.io" target="_blank" />
    </a>
    <!-- count click end -->
    <ul class="menu-link">
          <li><a href="../../index.html">Home</a></li>
          <li><a href="../../about.html">About</a></li>
          <li><a href="../../contact.html">Contact</a></li>
          <li><a href="../../pdf/resume.pdf">CV</a></li>
    </ul>
    </footer>
  </div>
  <!-- Footer End -->
            
          </div>
        <!-- Blog Post (Right Sidebar) End -->
        </div>
      </div>
    </div>
      
    <!-- Back to Top Start -->
    <a href="#" class="scroll-to-top"><i class="fa fa-long-arrow-up"></i></a>
    <!-- Back to Top End -->
    
    <!-- All Javascript Plugins  -->
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
    <script type="text/javascript" src="../../js/plugin.js"></script>
    
    <!-- Main Javascript File  -->
    <script type="text/javascript" src="../../js/scripts.js"></script>
    
    <!-- Syntax Highlighter Javascript File  -->
    <script type="text/javascript" src="../../js/syntax/shCore.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushCss.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushJScript.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushPerl.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushPhp.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushPlain.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushPython.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushRuby.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushSql.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushVb.js"></script>
    <script type="text/javascript" src="../../js/syntax/shBrushXml.js"></script>
    
	<!-- Syntax Highlighter Call Function -->
	<script type="text/javascript">
		SyntaxHighlighter.config.clipboardSwf = '../../js/syntax/clipboard.swf';
		SyntaxHighlighter.all();
	</script>

  </body>
</html>

